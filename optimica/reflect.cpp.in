// This program is only used to generate reflection information at build time
#include "mbl/config.hpp"
#include "util/config.hpp"
#include <iostream>
#include <nlohmann/json.hpp>
#include <sstream>

using json = nlohmann::json;

int main()
{
  setenv("JMODELICA_HOME", "${optimica_path}", 1);
  const std::string msl_dir = "${MSL_ROOT_DIR}/${MSL_VER}";

  json options;
  options["model"] =
      "Buildings.ThermalZones." + spawn::mbl_energyplus_version_string() + ".Validation.ThermalZone.OneZoneOneYear";

  options["outputDir"] = "${CMAKE_CURRENT_BINARY_DIR}/AirHeating";
  options["fmuType"] = "CS";
  options["mslDir"] = msl_dir;
  options["modelicaPaths"] = std::vector{"${PROJECT_BINARY_DIR}/mbl/MBL-prefix/src/MBL/Buildings"};

  std::stringstream cmd;
  cmd << "${Java_JAVA_EXECUTABLE}";
  cmd << " -agentlib:native-image-agent=config-output-dir=META-INF/native-image";
  cmd << " -classpath ${classpath}";
  cmd << " Optimica";
  cmd << " "
      << "'" << options << "'";

  return system(cmd.str().c_str());
}
